define(function(require, exports, module) {
    'use strict'

    // app's configuration
    M.config.site = "merchant"
    M.config.API = "http://api.mobile.meituan.com/group/v1/"
    if (location.href.indexOf('debug') > -1) {
        M.config.debug = true
    }

    var $ = require('$'),
        Handlebars = require('Handlebars'),
        _ = require('_'),
        Backbone = require('Backbone')

    var DetailView = require('/js/views/detail'),
        AllDealsView = require('/js/views/alldeals'),
        NearbyDealsView = require('/js/views/nearbydeals'),
        AllDealsModel = require('/js/models/alldeals'),
        NearbyDealsModel = require('/js/models/nearbydeals')

    M.app.DetailView = new DetailView()
    new NearbyDealsView()

    if (!initData.isMovie) {
        new AllDealsView()

        if (initData.hasBought) {
            NearbyDealsModel.fetch({
                dataType: "jsonp",
                url: NearbyDealsModel.urlRoot() + '&limit=10',
                success: function() {
                    AllDealsModel.fetch({
                        dataType: "jsonp",
                        error: function(xhr, errorType, error) {
                            M.log({
                                msg: "**EVE**fetch all deals data error | " + JSON.stringify(error),
                                url: AllDealsModel.urlRoot()
                            })
                        }
                    })
                },
                error: function(xhr, errorType, error) {
                    M.log({
                        msg: "**EVE**fetch nearby deals data error | " + JSON.stringify(error),
                        url: (NearbyDealsModel.urlRoot() + '&limit=10')
                    })
                }
            })
        } else {
            AllDealsModel.fetch({
                dataType: "jsonp",
                success: function() {
                    NearbyDealsModel.fetch({
                        dataType: "jsonp",
                        url: NearbyDealsModel.urlRoot() + '&limit=10',
                        error: function(xhr, errorType, error) {
                            M.log({
                                msg: "**EVE**fetch nearby deals data error | " + JSON.stringify(error),
                                url: (NearbyDealsModel.urlRoot() + '&limit=10')
                            })
                        }
                    })
                },
                error: function(xhr, errorType, error) {
                    M.log({
                        msg: "**EVE**fetch all deals data error | " + JSON.stringify(error),
                        url: AllDealsModel.urlRoot()
                    })
                }
            })
        }
    } else {
        NearbyDealsModel.fetch({
            dataType: "jsonp",
            url: NearbyDealsModel.urlRoot() + '&limit=10',
            error: function(xhr, errorType, error) {
                M.log({
                    msg: "**EVE**fetch nearby deals data error | " + JSON.stringify(error),
                    url: (NearbyDealsModel.urlRoot() + '&limit=10')
                })
            }
        })
    }
})
