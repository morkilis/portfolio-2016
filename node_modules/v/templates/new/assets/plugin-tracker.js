/**
 * error tracker plugin
 *
 * 依赖plugin-log.js
 */
define('M/plugin-tracker', [], function(require) {
    var pluginSDK = M.pluginSDK,
        config = M.config,
        log = require('./plugin-log')

    // Hacks compile function to inject error tracker & log support
    // ------------------------------------------------------------

    var MP = pluginSDK.Module.prototype,
        _compile = MP._compile

    MP._compile = function() {
        try {
            // TODO here return may cause error
            return _compile.apply(this, arguments)
        } catch(err) {
            M.log({
                msg: err.stack,
                url: location.href,
                site: config.site
            })
        }
    }

    if (!config.debug) {
        window.onerror = function(errorMsg, url, lineNumber) {
            M.log({
                msg: errorMsg,
                site: config.site,
                url: url,
                line: (lineNumber || null)
            })
            return true
        }
    }
})

M.use('M/plugin-tracker')
