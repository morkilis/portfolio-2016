/**
 * log plugin for debug
 *
 * TODO 这里到底需不需要再自己实现 each 和 param 方法
 */
define('M/plugin-log', [], function() {
    var TRACKER = 'http://fe.meituan.com/_.gif?'
        pluginSDK = M.pluginSDK,
        util = pluginSDK.util,
        config = M.config,
        escape = encodeURIComponent

    util.param = function(obj) {
        var params = []

        params.add = function(k, v) { this.push(escape(k) + '=' + escape(v)) }
        serialize(params, obj)

        return params.join('&').replace(/%20/g, '+')
    }

    util.each = function(elements, callback) {
        var i, key

        if (util.isArray(elements)) {
            for (var i = 0; i < elements.length; i ++)
                if (callback.call(elements[i], i, elements[i]) === false) return elemenets
        } else {
            for (var key in elements)
                if (callback.call(elements[key], key, elements[key]) === false) return elements
        }

        return elements
    }

    // override M.log
    M.log = function(info) {
        if (!config.debug) {
            beacon(info)
        } else {
            console.error(info)
        }
    }

    /**
     * 序列化数据
     */
    function serialize(params, obj, scope) {
        var isArray = util.isArray(obj)

        util.each(obj, function(key, value) {
            if (isArray) {
                params.add(value.name, value.value)
            } else if (util.isObject(value)) {
                serialize(params, value, key)
            } else {
                params.add(key, value)
            }
        })
    }

    /**
     * 向后台输出log
     */
    function beacon(msg) {
        msg.site = config.site || "eve"
        msg.level = "error"
        msg.url = msg.url || location.href
        msg.c = null
        msg.type = "jsdebug"
        msg.ts = Date.now()

        var img = new Image()
        img.src = TRACKER + util.param(msg)
    }
})

M.use('M/plugin-log')
