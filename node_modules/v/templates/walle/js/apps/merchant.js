var eve = eve || {}
    merchant = eve.merchant = eve.merchant || {}

;(function() {
    'use strict'

    // initialize
    $(
        eve.run(function() {
            new merchant.DetailView()
            new merchant.AllDealsView()
            new merchant.NearbyDealsView()

            if (initParams) {
                initParams = '&' + initParams;
            }
            if (!initData.isMovie) {
                if (initData.hasBought) {
                    fetchNearbyDeals(fetchAllDeals)
                } else {
                    fetchAllDeals(fetchNearbyDeals)
                }
            } else {
                fetchNearbyDeals()
            }

            /**
             * @description 数据加载失败
             * @param {Function} retry 必需，重试的方法
             * @param {Function} [optional] next, 重试成功后接下来调的方法
             *
             */
            function loadDataFailed(retry, next) {
                var msg = '加载失败，请点击重试'
                if (!navigator.onLine) {
                    msg = '网络连接失败，请点击重试'
                }
                $('#loading_tips').text(msg).on('click', function() {
                    var $this = $(this)

                    retry(function() {
                        $this.text('加载中...').off('click')
                        if (next && 'function' === typeof next) {
                            next()
                        }
                    })
                })
            }
            function fetchNearbyDeals(next) {
                var timer = setTimeout(function() {
                    loadDataFailed(fetchNearbyDeals, next)
                }, 60000)

                eve.run(function() {
                    merchant.NearbyDealsModel.fetch({
                        dataType: "jsonp",
                        url: merchant.NearbyDealsModel.urlRoot() + '&limit=10',
                        success: function() {
                            clearTimeout(timer)
                            if (next && 'function' === typeof next) {
                                next()
                            }
                        },
                        error: function() {
                            eve.log({
                                msg: "**EVE**fetch nearby deals data error | " + JSON.stringify(error),
                                // 后端会过滤到同一家店的不同deal, 这里的10是个估计,
                                // 我们认为一家店的deal不超过6个
                                url: (merchant.NearbyDealsModel.urlRoot() + '&limit=10')
                            })
                            loadDataFailed(fetchNearbyDeals, next)
                        }
                    })
                })
            }
            function fetchAllDeals(next) {
                var timer = setTimeout(function() {
                    loadDataFailed(fetchAllDeals, next)
                }, 60000)

                eve.run(function() {
                    merchant.AllDealsModel.fetch({
                        dataType: "jsonp",
                        success: function() {
                            clearTimeout(timer)
                            if (next && 'function' === typeof next) {
                                next()
                            }
                        },
                        error: function() {
                            eve.log({
                                msg: "**EVE**fetch all deals data error | " + JSON.stringify(error),
                                url: merchant.AllDealsModel.urlRoot()
                            })
                            loadDataFailed(fetchAllDeals, next)
                        }
                    })
                })
            }
        })
    )
}())
