var eve = eve || {},
    merchant = eve.merchant = eve.merchant || {}

;(function() {
    'use strict'

    var detailModel = merchant.detailModel

    merchant.DetailView = Backbone.View.extend({
        el: '#merchant',
        template: Handlebars.compile(eve.merchant.tmpl.detail),
        popPhoneTmpl: Handlebars.compile(eve.merchant.tmpl.pop_phone),
        events: {
            'click #call_phone': 'callPhone'
        },
        initialize: function() {
            var that = this
            eve.run(function() {
                that.$el.prepend(that.template(detailModel.toJSON()))
            }, {
                url: 'merchant detail view',
                line: 14
            })

            return this
        },
        callPhone: function(e) {
            var that = this,
                numbers = $('#call_phone').data('phone')

            if (numbers.indexOf('/') > -1) {
                e.preventDefault();
                var numbers = numbers.split('/'),
                    ret = numbers.map(function(num) {
                        return {
                            phone: num
                        }
                    })

                var $pop = $(that.popPhoneTmpl(ret)),
                    $doc = $(document),
                    $win = $(window),
                    height = $doc.height() > $win.height() ? $doc.height() : $win.height(),
                    width= $doc.width() > $win.width() ? $doc.width() : $win.width(),
                    $mask = $pop.find('#mask').css({height: height, width: width}),
                    $content = $pop.find('#pop_content')

                $('body').append($pop.css('left', width));
                $mask.on('click', function() {
                    that.removePop()
                })
                $content
                    .css({position: 'fixed', top: ($win.height() - $content.height())/2, left: ($win.width() - 275)/2})
                    .on('tap', 'a', function() {
                        setTimeout(function() {
                            that.removePop()
                        }, 500)
                    })
                $pop.css('left', 0).animate({ opacity: 1 }, 150, 'ease-in')
                return false
            } else {
                return true
            }
        },
        removePop: function() {
            var $pop = $('#pop_wrapper')

            if ($pop.length) {
                $pop.animate({ opacity: 0 }, 200, 'ease-out', function() {
                    $pop.remove()
                })
            }
        }
    })
}())
