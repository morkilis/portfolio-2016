var eve = eve || {},
    merchant = eve.merchant = eve.merchant || {}

;(function() {
    'use strict'

    var NearbyDealsModel = merchant.NearbyDealsModel
    merchant.NearbyDealsView = Backbone.View.extend({
        el: '#merchant',
        template: Handlebars.compile(eve.merchant.tmpl.nearby_deals),
        model: NearbyDealsModel,
        events: {
            'click .more-deals': 'getMoreDeals'
        },
        initialize: function() {
            _.bindAll(this, 'buildView', 'getMoreDeals')
            NearbyDealsModel.on('change', this.buildView, this)

            return this
        },
        buildView: function() {
            var that = this
            eve.run(function() {
                var $ndNearby = that.$el.find('#nearby_deals'),
                    nearbyDeals = NearbyDealsModel.toJSON()

                // '更多'按钮被点击时
                if ($ndNearby.length !== 0) {
                    $ndNearby.replaceWith(that.template(nearbyDeals));

                // 初始化‘附近团购’时
                } else {
                    if (nearbyDeals.data.length > 3) {
                        nearbyDeals.data = nearbyDeals.data.splice(0, 3)
                        nearbyDeals.data.push({mname: '更多'})
                    }
                    if (!initData.hasBought) {
                        that.$el.find('#loading_tips').remove()
                        that.$el.append(that.template(nearbyDeals))
                    } else {
                        that.$el.find('#loading_tips').before(that.template(nearbyDeals))
                    }
                }
            }, {
                msg: 'merchant nearby deals: buildView()'
            })
        },
        getMoreDeals: function() {
            var that = this,
                ndArrow = that.$el.find('.more-deals .icon-right'),
                spinner = new Spinner().spin()

            ndArrow.replaceWith(spinner.el)

            if (!that.hasTapped) {
                that.hasTapped = true;

                merchant.NearbyDealsModel.fetch({
                    dataType: "jsonp",
                    url: NearbyDealsModel.urlRoot() + "&limit=15",
                    success: function() {
                        spinner.stop()
                    },
                    error: function(xhr, errorType, error) {
                        that.hasTapped = false
                        spinner.stop()
                        eve.log({
                            msg: "**EVE**fetch more nearby deals data error | " + JSON.stringify(error),
                            url: merchant.NearbyDealsModel.urlRoot()
                        })
                    }
                })
            }
        }
    })
}())
